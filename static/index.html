<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyMetaVerse - í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .metaverse-preview {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 18px;
            margin: 20px 0;
        }
        .color-palette {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .color-box {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŸ MyMetaVerse í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ì‚¬ìš©ì ìƒì„± ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ‘¤ ì‚¬ìš©ì ìƒì„±</h2>
            <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…">
            <input type="email" id="email" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="createUser()">ì‚¬ìš©ì ìƒì„±</button>
            <div id="userResult" class="result"></div>
        </div>

        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ & ê³µê°„ ìƒì„±</h2>
            <input type="file" id="imageFile" accept="image/*">
            <button onclick="uploadImage()">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
            <div id="imageResult" class="result"></div>
        </div>

        <!-- ë©”íƒ€ë²„ìŠ¤ ê³µê°„ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="section">
            <h2>ğŸ  ë©”íƒ€ë²„ìŠ¤ ê³µê°„ ë¯¸ë¦¬ë³´ê¸°</h2>
            <div class="metaverse-preview" id="metaversePreview">
                ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì— 3D ê³µê°„ì´ ìƒì„±ë©ë‹ˆë‹¤!
            </div>
            <div id="spaceInfo" class="result"></div>
        </div>

        <!-- WebSocket í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h2>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
            <input type="number" id="userId" placeholder="ì‚¬ìš©ì ID" value="1">
            <button onclick="connectWebSocket()">WebSocket ì—°ê²°</button>
            <button onclick="disconnectWebSocket()">ì—°ê²° í•´ì œ</button>
            <div id="chatMessages" class="result" style="max-height: 200px; overflow-y: auto;"></div>
            <input type="text" id="chatMessage" placeholder="ë©”ì‹œì§€ ì…ë ¥">
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>

        <!-- ìºë¦­í„° ì›€ì§ì„ í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h2>ğŸ® ìºë¦­í„° ì›€ì§ì„ í…ŒìŠ¤íŠ¸</h2>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <button onclick="moveCharacter('forward')">â¬†ï¸ ì•ìœ¼ë¡œ</button>
                <button onclick="moveCharacter('backward')">â¬‡ï¸ ë’¤ë¡œ</button>
                <button onclick="moveCharacter('left')">â¬…ï¸ ì™¼ìª½</button>
                <button onclick="moveCharacter('right')">â¡ï¸ ì˜¤ë¥¸ìª½</button>
            </div>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <button onclick="moveCharacter('jump')">ğŸ¦˜ ì í”„</button>
                <button onclick="moveCharacter('sit')">ğŸª‘ ì•‰ê¸°</button>
                <button onclick="moveCharacter('dance')">ğŸ’ƒ ì¶¤ì¶”ê¸°</button>
            </div>
            <div id="characterPosition" class="result">ìºë¦­í„° ìœ„ì¹˜: [0, 0, 0]</div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentSpaceData = null;

        // ì‚¬ìš©ì ìƒì„±
        async function createUser() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/users/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    document.getElementById('userResult').textContent = `ì˜¤ë¥˜ (${response.status}): ${errorText}`;
                    return;
                }

                const result = await response.json();
                document.getElementById('userResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('userResult').textContent = 'ì˜¤ë¥˜: ' + error.message;
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...');
                console.log('íŒŒì¼:', file);
                
                const response = await fetch('/upload-image/', {
                    method: 'POST',
                    body: formData
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('ì‘ë‹µ í—¤ë”:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ì„œë²„ ì˜¤ë¥˜:', errorText);
                    document.getElementById('imageResult').textContent = `ì˜¤ë¥˜ (${response.status}): ${errorText}`;
                    return;
                }

                const result = await response.json();
                console.log('ë°›ì€ ë°ì´í„°:', result);
                document.getElementById('imageResult').textContent = JSON.stringify(result, null, 2);
                
                // ë©”íƒ€ë²„ìŠ¤ ê³µê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                // ì„œë²„ ì‘ë‹µ êµ¬ì¡°: result.space_data.space_data
                const spaceData = result.space_data && result.space_data.space_data ? result.space_data.space_data : result.space_data;
                console.log('ê³µê°„ ë°ì´í„°:', spaceData);
                updateMetaversePreview(spaceData);
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('imageResult').textContent = 'ì˜¤ë¥˜: ' + error.message;
            }
        }

        // ë©”íƒ€ë²„ìŠ¤ ê³µê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateMetaversePreview(spaceData) {
            const preview = document.getElementById('metaversePreview');
            const spaceInfo = document.getElementById('spaceInfo');
            
            currentSpaceData = spaceData;

            // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
            if (!spaceData || !spaceData.walls || !spaceData.floor || !spaceData.lighting || !spaceData.furniture) {
                preview.innerHTML = `
                    <div style="text-align: center;">
                        <h3>âš ï¸ ê³µê°„ ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p>ê³µê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ë°›ì€ ë°ì´í„°: ${JSON.stringify(spaceData)}</p>
                    </div>
                `;
                spaceInfo.textContent = JSON.stringify(spaceData, null, 2);
                return;
            }

            // ê°„ë‹¨í•œ 3D ê³µê°„ ì‹œê°í™” (CSSë¡œ êµ¬í˜„)
            const walls = spaceData.walls;
            const floor = spaceData.floor;
            const lighting = spaceData.lighting;
            const furniture = spaceData.furniture;

            preview.innerHTML = `
                <div style="text-align: center;">
                    <h3>ğŸ  ìƒì„±ëœ ë©”íƒ€ë²„ìŠ¤ ê³µê°„</h3>
                    <div class="color-palette">
                        <div class="color-box" style="background-color: ${walls.color || '#ffffff'}" title="ë²½ ìƒ‰ìƒ"></div>
                        <div class="color-box" style="background-color: ${floor.color || '#8B4513'}" title="ë°”ë‹¥ ìƒ‰ìƒ"></div>
                    </div>
                    <p>ì¡°ëª…: ${lighting.type || 'bright'} (ê°•ë„: ${lighting.intensity || 1.0})</p>
                    <p>ê°€êµ¬: ${furniture.length || 0}ê°œ</p>
                    <p>ìŠ¤íƒ€ì¼: ${spaceData.space_style || 'modern'}</p>
                    <p>ë¶„ìœ„ê¸°: ${spaceData.mood || 'neutral'}</p>
                </div>
            `;

            spaceInfo.textContent = JSON.stringify(spaceData, null, 2);
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const userId = document.getElementById('userId').value;
            
            ws = new WebSocket(`ws://localhost:8000/ws/${userId}`);
            
            ws.onopen = function(event) {
                addChatMessage('ì‹œìŠ¤í…œ', 'WebSocket ì—°ê²°ë¨!');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addChatMessage('ì„œë²„', JSON.stringify(data));
            };
            
            ws.onclose = function(event) {
                addChatMessage('ì‹œìŠ¤í…œ', 'WebSocket ì—°ê²° í•´ì œë¨');
            };
            
            ws.onerror = function(error) {
                addChatMessage('ì˜¤ë¥˜', 'WebSocket ì˜¤ë¥˜: ' + error);
            };
        }

        // WebSocket ì—°ê²° í•´ì œ
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            if (!ws) {
                alert('WebSocketì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }

            const message = document.getElementById('chatMessage').value;
            if (!message) return;

            const data = {
                type: 'chat',
                space_id: 1,
                message: message
            };

            ws.send(JSON.stringify(data));
            addChatMessage('ë‚˜', message);
            document.getElementById('chatMessage').value = '';
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const timestamp = new Date().toLocaleTimeString();
            chatMessages.textContent += `[${timestamp}] ${sender}: ${message}\n`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

                 // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
         document.getElementById('chatMessage').addEventListener('keypress', function(e) {
             if (e.key === 'Enter') {
                 sendMessage();
             }
         });

         // ìºë¦­í„° ì›€ì§ì„ ê´€ë ¨ ë³€ìˆ˜
         let characterPosition = { x: 0, y: 0, z: 0 };
         let characterAction = 'idle';

         // ìºë¦­í„° ì›€ì§ì„ í•¨ìˆ˜
         function moveCharacter(direction) {
             if (!ws) {
                 alert('WebSocketì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! ë¨¼ì € WebSocketì„ ì—°ê²°í•´ì£¼ì„¸ìš”.');
                 return;
             }

             // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
             switch (direction) {
                 case 'forward':
                     characterPosition.z -= 1;
                     characterAction = 'walking';
                     break;
                 case 'backward':
                     characterPosition.z += 1;
                     characterAction = 'walking';
                     break;
                 case 'left':
                     characterPosition.x -= 1;
                     characterAction = 'walking';
                     break;
                 case 'right':
                     characterPosition.x += 1;
                     characterAction = 'walking';
                     break;
                 case 'jump':
                     characterPosition.y += 1;
                     characterAction = 'jumping';
                     setTimeout(() => {
                         characterPosition.y -= 1;
                         characterAction = 'idle';
                         updateCharacterPosition();
                     }, 1000);
                     break;
                 case 'sit':
                     characterAction = 'sitting';
                     break;
                 case 'dance':
                     characterAction = 'dancing';
                     setTimeout(() => {
                         characterAction = 'idle';
                         updateCharacterPosition();
                     }, 3000);
                     break;
             }

             // ìœ„ì¹˜ í‘œì‹œ ì—…ë°ì´íŠ¸
             updateCharacterPosition();

             // WebSocketìœ¼ë¡œ ì´ë™ ë©”ì‹œì§€ ì „ì†¡
             const moveData = {
                 type: 'move',
                 space_id: 1,
                 position: characterPosition,
                 action: characterAction
             };

             ws.send(JSON.stringify(moveData));
             addChatMessage('ì‹œìŠ¤í…œ', `ìºë¦­í„° ${direction} ì´ë™! ìœ„ì¹˜: [${characterPosition.x}, ${characterPosition.y}, ${characterPosition.z}]`);
         }

         // ìºë¦­í„° ìœ„ì¹˜ ì—…ë°ì´íŠ¸
         function updateCharacterPosition() {
             const positionDiv = document.getElementById('characterPosition');
             const actionText = characterAction !== 'idle' ? ` (${characterAction})` : '';
             positionDiv.textContent = `ìºë¦­í„° ìœ„ì¹˜: [${characterPosition.x}, ${characterPosition.y}, ${characterPosition.z}]${actionText}`;
         }

         // í‚¤ë³´ë“œë¡œ ìºë¦­í„° ì¡°ì‘
         document.addEventListener('keydown', function(e) {
             if (!ws) return; // WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ

             switch (e.key) {
                 case 'ArrowUp':
                 case 'w':
                 case 'W':
                     e.preventDefault();
                     moveCharacter('forward');
                     break;
                 case 'ArrowDown':
                 case 's':
                 case 'S':
                     e.preventDefault();
                     moveCharacter('backward');
                     break;
                 case 'ArrowLeft':
                 case 'a':
                 case 'A':
                     e.preventDefault();
                     moveCharacter('left');
                     break;
                 case 'ArrowRight':
                 case 'd':
                 case 'D':
                     e.preventDefault();
                     moveCharacter('right');
                     break;
                 case ' ':
                     e.preventDefault();
                     moveCharacter('jump');
                     break;
                 case 'Enter':
                     e.preventDefault();
                     moveCharacter('sit');
                     break;
             }
         });
    </script>
</body>
</html>
